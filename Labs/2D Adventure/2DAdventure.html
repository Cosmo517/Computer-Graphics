<html lang="en">
    <HEAD>
        <meta charset="UTF-8">
        <title>2D Adventure</title>
        <style>
            html, body {
                margin: 0 !important;
                padding: 0 !important;
            }
        </style>
    </HEAD>
    <body>
		<CANVAS id="myCanvas" width="896" height="512">
			Your browser does not support canvas.
		</CANVAS>
        <script>
            class Main {
                constructor(ctx) {
                    this.ctx = ctx;
                    this.player = 0;
                    this.enemies = [];
                    // 0 is free, 1 is wall, 2 is tree
                    // 3 is potion, 4 is player, 5 is monster
                    this.obstacles = [];
                    this.canvasWidth = 896;
                    this.canvasHeight = 512;

                    for (let i = 0; i < this.canvasHeight / 64; i++) {
                        const row = [];
                        for (let j = 0; j < this.canvasWidth / 64; j++) {
                            row.push(0);
                        }
                        this.obstacles.push(row)
                    }

                    this.drawMap()
                }

                drawBrick(xStart, yStart) {
                    this.ctx.beginPath();

                    // Top line
                    this.ctx.moveTo(xStart, yStart);
                    this.ctx.lineTo(xStart + 64, yStart);

                    // Left side vertical
                    this.ctx.moveTo(xStart, yStart);
                    this.ctx.lineTo(xStart, yStart + 64);

                    // Right side vertical
                    this.ctx.moveTo(xStart + 64, yStart);
                    this.ctx.lineTo(xStart + 64, yStart + 64);

                    // Bottom horizontal
                    this.ctx.moveTo(xStart, yStart + 64);
                    this.ctx.lineTo(xStart + 64, yStart + 64);

                    let newYStart = yStart
                    for (let i = 0; i < 3; i++) {
                        // Vert lines down 13 units
                        this.ctx.moveTo(xStart + 8, newYStart);
                        this.ctx.lineTo(xStart + 8, newYStart + 13);
                        this.ctx.moveTo(xStart + 32, newYStart);
                        this.ctx.lineTo(xStart + 32, newYStart + 13)
                        this.ctx.moveTo(xStart + 56, newYStart);
                        this.ctx.lineTo(xStart + 56, newYStart + 13);

                        // 2nd line horizontal 
                        if (i != 2) {
                            this.ctx.moveTo(xStart, newYStart + 13);
                            this.ctx.lineTo(xStart + 64, newYStart + 13);
                        } else { 
                            break;
                        }

                        newYStart += 13;

                        // Vert lines down 13 units
                        this.ctx.moveTo(xStart + 16, newYStart);
                        this.ctx.lineTo(xStart + 16, newYStart + 13);
                        this.ctx.moveTo(xStart + 48, newYStart);
                        this.ctx.lineTo(xStart + 48, newYStart + 13)

                        // 2nd line horizontal
                        this.ctx.moveTo(xStart, newYStart + 13);
                        this.ctx.lineTo(xStart + 64, newYStart + 13);

                        newYStart += 13;
                    }
                    
                    this.ctx.stroke();
                }

                drawTree(xStart, yStart) {
                    this.ctx.beginPath();
                    
                    this.ctx.strokeStyle = "black";
                    this.ctx.fillStyle = "brown";
                    this.ctx.fillRect(xStart + 24, yStart + 24, 16, 40);
                    this.ctx.stroke();

                    this.ctx.strokeStyle = "black";
                    this.ctx.fillStyle = "green"
                    this.ctx.arc(xStart + 32 , yStart + 24, 24, 0, Math.PI * 2, 1);
                    this.ctx.fill();

                    this.ctx.stroke();
                }

                drawMap() {
                    // Draw brick border
                    for (let y = 0; y < this.canvasHeight / 64; y++) {
                        for (let x = 0; x < this.canvasWidth / 64; x++) {
                            if (y == 0 || y == (this.canvasHeight / 64) - 1) {
                                this.drawBrick(x * 64, y * 64);
                                this.obstacles[y][x] = 1;
                            }

                            if ((y != 0 && y != (this.canvasHeight / 64) - 1) && (x == 0 || x == (this.canvasWidth / 64) - 1)) {
                                this.drawBrick(x * 64, y * 64);
                                this.obstacles[y][x] = 1;
                            }
                        }
                    }

                    // Draw Trees
                    const totalTrees = 15;
                    let currentTrees = 0;

                    while (currentTrees < totalTrees) {
                        const xTest = Math.floor(Math.random() * (this.canvasWidth / 64));
                        const yTest = Math.floor(Math.random() * (this.canvasHeight / 64));

                        if (!this.obstacles[yTest][xTest]) {
                            this.drawTree(xTest * 64, yTest * 64);
                            this.obstacles[yTest][xTest] = 2
                            currentTrees++;
                        }
                    }

                    // Grab a random location that is traversable
                    let xTest = 0;
                    let yTest = 0;
                    do {
                        xTest = Math.floor(Math.random() * (this.canvasWidth / 64));
                        yTest = Math.floor(Math.random() * (this.canvasHeight / 64));
                    } while (this.obstacles[yTest][xTest] != 0)

                    // If we cannot traverse to every square, regenerate the map
                    if (this.checkUnreachableSpots(structuredClone(this.obstacles), xTest, yTest, 0)) {
                        console.log("Found unreachable spot... Redrawing map");
                        for (let i = 0; i < this.canvasHeight / 64; i++) {
                            for (let j = 0; j < this.canvasWidth / 64; j++) {
                                if (this.obstacles[i][j] == 2) {
                                    this.obstacles[i][j] = 0;
                                }
                            }
                        }
                        this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
                        this.drawMap();
                    }
                }

                checkUnreachableSpots(obstacles, x, y, depth) {
                    obstacles[y][x] = 10;

                    // + 1 is going down for y axis
                    if (obstacles[y + 1][x] == 0) {
                        this.checkUnreachableSpots(obstacles, x, y + 1, depth + 1);
                    }
                    if (obstacles[y - 1][x] == 0) {
                        this.checkUnreachableSpots(obstacles, x, y - 1, depth + 1);
                    }
                    if (obstacles[y][x + 1] == 0) {
                        this.checkUnreachableSpots(obstacles, x + 1, y, depth + 1);
                    }
                    if (obstacles[y][x - 1] == 0) {
                        this.checkUnreachableSpots(obstacles, x - 1, y, depth + 1);
                    }

                    // Check if there is an unreachable spot... if there is
                    // return true, otherwise false
                    if (depth == 0) {
                        for (let i = 0; i < this.canvasHeight / 64; i++) {
                            for (let j = 0; j < this.canvasWidth / 64; j++) {
                                if (obstacles[i][j] == 0) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                }

                update() {

                }
            }

            class Character {
                constructor(hp, mhp, atk, def, x, y, image) {
                    this.hp = hp;
                    this.mhp = mhp;
                    this.atk = atk;
                    this.def = def;
                    this.x = x;
                    this.y = y;
                    this.image = image;
                }

                damage(enemy) {
                    this.hp -= Math.max(enemy.atk - this.def, 1) * (Math.floor(Math.random() * 6) + 1);
                }
            }

            class Player extends Character {
                constructor(hp, mhp, atk, def, x, y, image) {
                    super(hp, mhp, atk, def, x, y, image);
                }
            }

            class Monster extends Character {
                constructor(hp, mhp, atk, def, x, y, image) {
                    super(hp, mhp, atk, def, x, y, image);
                }
            }

            const canvas = document.getElementById("myCanvas");

            canvas.width = 896;
            canvas.height = 512;

            const ctx = canvas.getContext("2d");   

            const game = new Main(ctx);
        </script>
    </body>
</html>